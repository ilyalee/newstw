<html>
<title>大肚山計畫媒體輿情剪報系統 - PROTOTYPE</title>
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.1/css/materialize.min.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    blockquote {
      text-align: left;
      white-space: normal;
      font-size: small;
      color: #999;
    }

    ul.header > li > a, .card-title {
      font-size: large;
    }

    .chip {
      font-size: x-small;
    }

  </style>
</head>
<body>
  <nav>
    <div class="nav-wrapper yellow darken-3">
      <div class="row">
        <div class="col">
          {%- if not data['orig_keyword'] and not data['category'] -%}
          <ul class="header">
            <li><a href="?">總覽</a></li>
            <li><a href="?cat=pmedia">平面</a></li>
            <li><a href="?cat=emedia">電子</a></li>
          </ul>
          {% else %}
            <a class="breadcrumb" href="?keyword={{ data['parent'] | default('', true) }}">
            {{ data['parent'] or data['category_zh_tw'] | default('總覽', true) }} ({{ data['parent_count'] }})</a>
            {%- if data['orig_keyword'] -%}
            <a class="breadcrumb">{{ data['orig_keyword'] }} ({{ data['count'] }})</a>
            {% endif %}
          {% endif %}
        </div>
        <div class="col right hide-on-small-only">
          <form>
            <div class="input-field">
              <input name="keyword" id="keyword" type="search" action="" method="get" required>
              <label class="label-icon" for="search"><i class="material-icons">search</i></label>
              <i class="material-icons">close</i>
            </div>
          </form>
        </div>
      </div>
    </div>
  </nav>
  <ul id="cards">
  {% for item in data['items'] %}
    <li class="card-panel hoverable">
      <div class="card-content">
        <span class="card-title blue-text text-darken-1">
          <i class="material-icons">add</i>
          {{ item['title'] | hightlight_keywords(data['keyword']) | safe }}
        </span>
        <p class="left">
          <blockquote class="truncate">
            {{ item['summary'] | hightlight_keywords(data['keyword']) | safe }}
          </blockquote>
        </p>
      </div>
      <span class="chip grey-text">{{ item['published_humanize'] }}</span>
      <a class="chip orange lighten-3 white-text" href="?cat={{ item['source'] }}">{{ item['source'] }}</a>
      <span class="chip green lighten-3 white-text">#{{ item['id'] }}</span>
      {% for keyword in item['founds'] %}
      <a class="chip red lighten-3 white-text" href="?keyword={{ keyword }}">
        {{ keyword }}
      </a>
      {% endfor %}
      <div class="card-action">
        <p class="right-align">
          <a class="waves-effect waves-light grey btn" target="_blank" href="{{ item['link'] }}">新聞連結</a>
        </p>
      </div>
    </li>
  {% endfor %}
  </ul>

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.1/js/materialize.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>

  {% raw %}
  <script id="card-template" type="text/x-handlebars-template">
    <li class="card-panel hoverable">
      <div class="card-content">
        <span class="card-title blue-text text-darken-1">
          <i class="material-icons">add</i>
          {{{ title }}}
        </span>
        <p class="left">
          <blockquote class="truncate">
            {{{ summary }}}
          </blockquote>
        </p>
      </div>
      <span class="chip grey-text">{{ published_humanize }}</span>
      <a class="chip orange lighten-3 white-text" href="?cat={{ source }}">{{ source }}</a>
      <span class="chip green lighten-3 white-text">#{{ id }}</span>
      {{#list founds}}
        {{keyword}}
      {{/list}}
      <div class="card-action">
        <p class="right-align">
          <a class="waves-effect waves-light grey btn" target="_blank" href="{{ link }}">新聞連結</a>
        </p>
      </div>
    </li>
  </script>

  <script type="text/javascript">
    jQuery.urlParam = function(name) {
      var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href)
      if (results) {
        return results[1] || 0
      } else {
        return null
      }
    }

    Handlebars.registerHelper('list', function(items) {
      var out = ''
      for(var i = 0, l = items.length; i < l; i++) {
        out = out + '<a class="chip red lighten-3 white-text" href="?keyword='+ items[i] +'">' + items[i] + '</a>'
      }
      return out
    })

    var url = 'api/v1/archive/list?'
    var page = 1
    var limit = 10

    keyword = jQuery.urlParam('keyword') || ''
    keyword = decodeURIComponent(keyword)
    limit = jQuery.urlParam('limit') || limit
    page = jQuery.urlParam('page') || page
    cat = jQuery.urlParam('cat') || ''
    cat = decodeURIComponent(cat)

    var done = false
    var showed = false
    window.addEventListener('scroll', jQuery.throttle( 250, function() {
      var wrap = document.getElementById('cards')
      var contentHeight = wrap.offsetHeight
      var yOffset = window.pageYOffset
      var y = yOffset + window.innerHeight
      if (y >= contentHeight) {
        if (showed && done) {
          Materialize.toast("已經到底了 _(:з」∠)_", 3000)
          showed = true
          return showed
        }

        page = page + 1
        var params = jQuery.param({ page, limit, cat, keyword })

        fetch(url + params)
          .then(function(response) {
            return response.json()
          }).then(function(json) {
            if (json.length == 0) {
              done = true
              return done
            }
            var source   = $("#card-template").html()
            var template = Handlebars.compile(source)
            jQuery.each(json, function (index, item) {
              var context = item
              var html = template(context)
              jQuery('#cards').append(html)
            })
          }).catch(function(ex) {
            // pass
          })
        }
      }))

  </script>
  {% endraw %}
</body>
</html>
